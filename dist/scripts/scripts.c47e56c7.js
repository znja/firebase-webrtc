"use strict";angular.module("firebaseApp",["ngResource","ngRoute","ngSanitize","firebase","LocalStorageModule"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).when("/about",{templateUrl:"views/about.html",controller:"AboutCtrl"}).when("/room/:id",{templateUrl:"views/room.html",controller:"RoomCtrl"}).when("/list",{templateUrl:"views/list.html",controller:"ListCtrl"}).otherwise({redirectTo:"/"})}]),window.RTCPeerConnection=window.RTCPeerConnection||window.webkitRTCPeerConnection||window.mozRTCPeerConnection,window.RTCIceCandidate=window.RTCIceCandidate||window.mozRTCIceCandidate||window.webkitRTCIceCandidate,window.RTCSessionDescription=window.RTCSessionDescription||window.mozRTCSessionDescription||window.webkitRTCSessionDescription,window.URL=window.URL||window.mozURL||window.webkitURL,window.navigator.getUserMedia=window.navigator.getUserMedia||window.navigator.webkitGetUserMedia||window.navigator.mozGetUserMedia,window.URL=window.URL||window.mozURL||window.webkitURL,angular.module("firebaseApp").controller("MainCtrl",["$scope","$location","$firebase","localStorageService","config",function(a,b,c,d,e){var f=new Firebase(e.firebaseURL),g=c(f);a.username=d.get("userName"),a.submitUsername=function(){d.set("userName",a.email),a.username=a.email},a.create=function(){g.$push({createdBy:a.username,createdAt:Date.now(),status:"created",peers:null,signaling:null}).then(function(a){console.log("Record added: ",a.key()),b.path("/room/"+a.key())})},a.toList=function(){b.path("/list")}}]),angular.module("firebaseApp").controller("AboutCtrl",["$scope",function(a){a.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"]}]),angular.module("firebaseApp").controller("RoomCtrl",["$scope","$routeParams","$sce","$firebase","config","webrtcFactory","camaraService",function(a,b,c,d,e,f,g){var h,i,j=b.id,k=new Firebase(e.firebaseURL+"/room"+j),l=(k.child("signaling"),d(k));a.remoteStreams=[],l.$asObject().$loaded().then(function(b){a.session=b}),g.getVideo().then(function(b){h=b,i=b.objectURL,f.join(b,j,a.remoteStreams)}),a.localStream=function(){return c.trustAsResourceUrl(i)},a.mute=function(){g.mute()},a.stop=function(){g.stop()},a.remotePeer=[]}]),angular.module("firebaseApp").controller("ListCtrl",["$scope","$location","$firebase","config",function(a,b,c,d){var e=new Firebase(d.firebaseURL),f=c(e);f.$asArray().$loaded().then(function(b){a.list=b}),a.join=function(a){b.path("/room/"+a)}}]),angular.module("firebaseApp").factory("webrtcFactory",["$window","$q","$firebase","config","localStorageService",function(a,b,c,d,f){function g(a){if(u[a])return u[a];var b=new RTCPeerConnection(v);return u[a]=b,m&&b.addStream(m),b.onicecandidate=function(b){s.signal={from:o,to:a,ice:b.candidate,type:"ice"},s.$save().then(function(){console.log("type Ice sending signal: ",s.signal)})},b.onaddstream=function(b){console.log("Received new stream",a,b.stream),w.push({id:a,stream:URL.createObjectURL(b.stream)})},b}function h(a){var b=g(a);b.createOffer(function(c){b.setLocalDescription(c),console.log("Creating an offer for",a),s.signal={from:o,to:a,sdp:c,type:"sdp-offer"},s.$save().then(function(){console.log("type sdp-offer sending signal: ",s.signal)})},function(a){console.log(a)},{mandatory:{OfferToReceiveVideo:!0,OfferToReceiveAudio:!0}})}function i(){var a=b.defer();return c(p.child("peers")).$asArray().$loaded().then(function(b){q=b,q.$watch(x),a.resolve()}),a.promise}function j(a){var b=g(a.from);switch(a.type){case"sdp-offer":b.setRemoteDescription(new RTCSessionDescription(a.sdp),function(){console.log("Setting remote description by offer"),b.createAnswer(function(c){b.setLocalDescription(c),s.signal={from:o,to:a.from,sdp:c,type:"sdp-answer"},s.$save().then(function(){console.log("sdp-answer sending signal: ",s.signal)})})});break;case"sdp-answer":b.setRemoteDescription(new RTCSessionDescription(a.sdp),function(){console.log("Setting remote description by answer")},function(a){console.error(a)});break;case"ice":a.ice&&(console.log("Adding ice candidates"),b.addIceCandidate(new RTCIceCandidate(a.ice)))}}function k(){s.$watch(function(){s.signal.to===o&&(console.log("incoming Signal: ",s.signal),j(s.signal))})}function l(a){var e=b.defer();return p=new Firebase(d.firebaseURL+a),i().then(function(){r=c(p.child("signaling")),r.$asObject().$loaded().then(function(a){s=a,k(),e.resolve()})}),e.promise}var m,n,o,p,q,r,s,t=f.get("userName"),u={},v=d.iceConfig,w=[],x=function(a){"child_added"===a.event?(console.log("Peer Joined: ",q.$getRecord(a.key).$value),a.key!==o&&h(a.key)):console.log("event: ",e)},y=function(a,b,c){m=a,n=b,w=c,l(b).then(function(){_.each(q,function(a){a.$value===t&&(o=a.$id)}),o||q.$add(t).then(function(a){o=a.key()})})};return{join:y}}]),angular.module("firebaseApp").factory("adapter",["$window",function(a){return{RTCPeerConnection:a.RTCPeerConnection||a.webkitRTCPeerConnection||a.mozRTCPeerConnection,RTCIceCandidate:a.RTCIceCandidate||a.mozRTCIceCandidate||a.webkitRTCIceCandidate,RTCSessionDescription:a.RTCSessionDescription||a.mozRTCSessionDescription||a.webkitRTCSessionDescription,getUserMedia:a.navigator.getUserMedia||a.navigator.webkitGetUserMedia||a.navigator.mozGetUserMedia}}]),angular.module("firebaseApp").service("camaraService",["$window","$q",function(a,b){var c,d={audio:!0,video:!0},e=this;e.getVideo=function(){var e=b.defer();return c?b.when(c):(a.navigator.getUserMedia(d,function(b){c=b,c.objectURL=a.URL.createObjectURL(c),e.resolve(c)},function(a){e.reject("getUserMedia error: ",a)}),e.promise)},e.mute=function(){c&&(c.getAudioTracks()[0].enabled=!c.getAudioTracks()[0].enabled)},e.stop=function(){c&&(c.getVideoTracks()[0].enabled=!c.getVideoTracks()[0].enabled)}}]),angular.module("firebaseApp").constant("config",{firebaseURL:"https://webrtc-cloud.firebaseio.com/",iceServers:{iceServers:[{url:"stun:stun.l.google.com:19302"},{url:"turn:numb.viagenie.ca",credential:"muazkh",username:"webrtc@live.com"},{url:"turn:192.158.29.39:3478?transport=udp",credential:"JZEOEt2V3Qb0y27GRntt2u2PAYA=",username:"28224511:1379330808"},{url:"turn:192.158.29.39:3478?transport=tcp",credential:"JZEOEt2V3Qb0y27GRntt2u2PAYA=",username:"28224511:1379330808"}]}}),angular.module("firebaseApp").directive("videoPlayer",["$sce",function(a){return{template:'<div><video ng-src="{{trustSrc()}}" autoplay></video></div>',restrict:"E",replace:!0,scope:{vidSrc:"@"},link:function(b){console.log("Initializing video-player"),b.trustSrc=function(){return b.vidSrc?a.trustAsResourceUrl(b.vidSrc):void 0}}}}]);